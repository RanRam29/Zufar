<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Casualty Management</title>
  <style>
    body {font-family: system-ui, Arial, sans-serif; margin: 0; background:#fafafa;}
    header {padding:16px 20px; background:#0f172a; color:#fff; font-weight:600;}
    main {max-width: 900px; margin: 20px auto; padding: 0 16px;}
    .card {background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); margin-bottom:16px;}
    .card h3 {margin:0; padding:16px;}
    .section {padding:16px; border-top:1px solid #f1f5f9;}
    .row {display:flex; gap:12px; flex-wrap:wrap;}
    .row > * {flex:1 1 200px;}
    button {padding:8px 12px; border-radius:10px; border:1px solid #0ea5e9; background:#0ea5e9; color:#fff; cursor:pointer;}
    button.outline {background:#fff; color:#0ea5e9;}
    .badge {display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb;}
    .muted {color:#64748b; font-size:12px;}
    pre.error {white-space:pre-wrap; background:#fee; border:1px solid #f99; padding:12px; border-radius:8px;}
    #eventsList .item {padding:12px 16px; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;}
    #eventsList .title {font-weight:600}
  </style>
  <script>
    // Surface any runtime error instead of a blank screen
    window.onerror = function (msg, url, line, col, err) {
      const pre = document.createElement('pre');
      pre.className = 'error';
      pre.textContent = 'Frontend crash:\\n' + (err && err.stack ? err.stack : (msg + ' @ ' + url + ':' + line));
      document.getElementById('errors').appendChild(pre);
    };
  </script>
</head>
<body>
<header>Casualty Management</header>
<main>
  <div id="errors"></div>

  <div class="card">
    <h3>Create Event</h3>
    <div class="section">
      <form id="createForm" class="row">
        <input name="title" placeholder="Title" required />
        <input name="description" placeholder="Description" required />
        <input name="reporter" placeholder="Reporter" required />
        <select name="severity" required>
          <option value="low">low</option><option value="medium">medium</option><option value="high">high</option>
        </select>
        <input name="lat" placeholder="Lat" type="number" step="any" required />
        <input name="lng" placeholder="Lng" type="number" step="any" required />
        <input name="people_required" placeholder="People required" type="number" value="1" min="1" required />
        <input name="casualties_count" placeholder="Casualties" type="number" value="0" min="0" required />
        <input name="event_time" type="datetime-local" required />
        <button type="submit">Create</button>
      </form>
    </div>
  </div>

  <div class="card">
    <h3>Events <span id="count" class="badge muted">0</span></h3>
    <div class="section">
      <div style="margin-bottom:10px">
        <button id="refreshBtn" class="outline">Refresh</button>
      </div>
      <div id="eventsList"></div>
    </div>
  </div>
</main>

<script>
  const API_BASE = window.location.origin;                    // e.g., https://zufar.onrender.com
  const WS_URL   = (API_BASE.startsWith('https') ? 'wss' : 'ws') + '://' + window.location.host + '/ws/events';

  function fmt(dtStr){ try{return new Date(dtStr).toLocaleString();}catch{return dtStr;} }

  async function loadEvents(){
    const list = document.getElementById('eventsList');
    list.innerHTML = '<div class="muted" style="padding:8px 16px">Loading…</div>';
    try{
      const res = await fetch(API_BASE + '/events');
      if(!res.ok){ throw new Error('GET /events ' + res.status); }
      const data = await res.json();
      document.getElementById('count').textContent = data.length;
      list.innerHTML = '';
      data.sort((a,b)=>new Date(b.event_time)-new Date(a.event_time));
      data.forEach(e=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div>
            <div class="title">${e.title} <span class="badge">${e.status}</span></div>
            <div class="muted">Severity: ${e.severity} • ${fmt(e.event_time)} • ${e.people_count}/${e.people_required} • casualties ${e.casualties_count}</div>
          </div>
          <div>
            <button class="outline" onclick="joinEvent(${e.id})">Join</button>
          </div>`;
        list.appendChild(div);
      });
      if(data.length===0){ list.innerHTML = '<div class="muted" style="padding:8px 16px">No events yet.</div>'; }
    }catch(err){
      list.innerHTML = '';
      const pre = document.createElement('pre'); pre.className='error'; pre.textContent = String(err);
      document.getElementById('errors').appendChild(pre);
    }
  }

  async function joinEvent(eventId){
    const username = prompt('Enter your name to join:');
    if(!username) return;
    const res = await fetch(API_BASE + '/events/join', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ event_id: eventId, username })
    });
    if(!res.ok){
      const txt = await res.text();
      alert('Join failed: ' + res.status + ' ' + txt);
    } else {
      loadEvents();
    }
  }

  document.getElementById('createForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.target;
    const payload = {
      title: f.title.value, description: f.description.value, reporter: f.reporter.value,
      severity: f.severity.value, lat: parseFloat(f.lat.value), lng: parseFloat(f.lng.value),
      people_required: parseInt(f.people_required.value,10), casualties_count: parseInt(f.casualties_count.value,10),
      event_time: new Date(f.event_time.value).toISOString()
    };
    const res = await fetch(API_BASE + '/events', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!res.ok){ const txt = await res.text(); alert('Create failed: ' + res.status + ' ' + txt); }
    f.reset(); loadEvents();
  });

  document.getElementById('refreshBtn').addEventListener('click', loadEvents);

  (function initWS(){
    const ws = new WebSocket(WS_URL);
    ws.onopen = ()=> { console.log('WS connected', WS_URL); setInterval(()=>{ try{ ws.send('ping'); }catch{} }, 25000); };
    ws.onmessage = ()=> loadEvents();
    ws.onerror = (e)=> console.warn('WS error', e);
    ws.onclose = ()=> { console.warn('WS closed; retrying in 2s'); setTimeout(initWS, 2000); };
  })();

  loadEvents();
</script>
</body>
</html>
