<!doctype html>
<html lang="he"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zufar – ניהול אירועים</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
header { background:#0b3d91;color:#fff;padding:10px;text-align:center; }
nav button { margin:5px; padding:5px 10px; }
#map{ height: 400px; } .hidden{display:none;}
.event-card{border:1px solid #ccc;padding:8px;margin:5px;border-radius:4px;}
.form-group{margin-bottom:10px;} label{display:block;margin-bottom:4px;} input,textarea,select{width:100%;padding:6px;}
</style></head>
<body>
<header><h1>📍 Zufar – ניהול אירועים</h1></header>
<nav>
  <button onclick="showTab('map-tab')">מפה</button>
  <button onclick="showTab('auth-tab')">התחברות / הרשמה</button>
  <button onclick="showTab('history-tab')">אירועים היסטוריים</button>
</nav>
<section id="map-tab">
  <div id="map"></div>
  <h2>אירועים פעילים</h2>
  <div id="events-list"></div>
  <h3>צור אירוע חדש</h3>
  <div id="create-event-form">
    <div class="form-group"><label>כותרת</label><input id="title" type="text"/></div>
    <div class="form-group"><label>חומרה</label>
      <select id="severity"><option value="low">נמוכה</option><option value="medium">בינונית</option><option value="high">גבוהה</option></select>
    </div>
    <div class="form-group"><label>תיאור</label><textarea id="description"></textarea></div>
    <div class="form-group"><label>כתובת (בישראל)</label><input id="address" type="text"/> <button onclick="geocodeAddress()">🔍 מצא נקודת ציון</button></div>
    <div class="form-group"><label>Lat</label><input id="lat" type="number" step="any"/><label>Lng</label><input id="lng" type="number" step="any"/></div>
    <div class="form-group"><label>מספר אנשים נדרש</label><input id="people_required" type="number" value="5"/></div>
    <button onclick="createEvent()">צור אירוע</button>
  </div>
</section>
<section id="auth-tab" class="hidden">
  <h2>הרשמה</h2>
  <div class="form-group"><label>שם משתמש</label><input id="reg-username" type="text"/></div>
  <div class="form-group"><label>אימייל</label><input id="reg-email" type="email"/></div>
  <div class="form-group"><label>סיסמה</label><input id="reg-password" type="password"/></div>
  <button onclick="register()">הירשם</button>
  <h2>התחברות</h2>
  <div class="form-group"><label>שם משתמש</label><input id="login-username" type="text"/></div>
  <div class="form-group"><label>סיסמה</label><input id="login-password" type="password"/></div>
  <button onclick="login()">התחבר</button>
  <div><button onclick="enableNotifications()">הפעל התראות</button></div>
</section>
<section id="history-tab" class="hidden">
  <h2>אירועים היסטוריים</h2><div id="history-list"></div>
</section>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_BASE = window.location.origin; let map, markers={}, token=null;
function showTab(id){document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden");}
function initMap(){map=L.map('map').setView([31.0461,34.8516],8);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Map data © OpenStreetMap'}).addTo(map);}
async function fetchEvents(){const res=await fetch(`${API_BASE}/events`);const data=await res.json();document.getElementById("events-list").innerHTML="";data.forEach(ev=>{const card=document.createElement("div");card.className="event-card";card.innerHTML=`<b>${ev.title}</b> (${ev.severity}) – ${ev.people_count}/${ev.people_required} משתתפים<br><button onclick="joinEvent(${ev.id})">הצטרף</button> <button onclick="editEventPrompt(${ev.id})">ערוך</button>`;document.getElementById("events-list").appendChild(card);if(!markers[ev.id]){markers[ev.id]=L.marker([ev.lat,ev.lng]).addTo(map).bindPopup(ev.title);}else{markers[ev.id].setLatLng([ev.lat,ev.lng]).setPopupContent(ev.title);}})}
async function fetchHistory(){const r=await fetch(`${API_BASE}/events/history`);const data=await r.json();const c=document.getElementById("history-list");c.innerHTML="";data.forEach(ev=>{const card=document.createElement("div");card.className="event-card";card.innerHTML=`<b>${ev.title}</b> (${ev.severity}) – נסגר`;c.appendChild(card);});}
async function createEvent(){const payload={title:document.getElementById("title").value,severity:document.getElementById("severity").value,description:document.getElementById("description").value,address:document.getElementById("address").value,lat:parseFloat(document.getElementById("lat").value),lng:parseFloat(document.getElementById("lng").value),people_required:parseInt(document.getElementById("people_required").value)};const res=await fetch(`${API_BASE}/events`,{method:"POST",headers:{"Content-Type":"application/json",...(token?{Authorization:`Bearer ${token}`}:{})},body:JSON.stringify(payload)});if(res.ok){alert("אירוע נוצר");fetchEvents();}else{alert("שגיאה ביצירת האירוע");}}
async function editEventPrompt(id){const newRequired=prompt("מספר משתתפים נדרש חדש (או השאר ריק):");const newTitle=prompt("כותרת חדשה (או ריק):");const body={};if(newRequired) body.people_required=parseInt(newRequired);if(newTitle) body.title=newTitle;if(!Object.keys(body).length) return;const res=await fetch(`${API_BASE}/events/${id}/edit`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(res.ok){fetchEvents();}else{alert("עריכה נכשלה");}}
async function joinEvent(id){const username=prompt("הכנס שם להצטרפות:");if(!username) return;const res=await fetch(`${API_BASE}/events/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event_id:id,username})});if(res.ok){alert("הצטרפת לאירוע");fetchEvents();}}
async function geocodeAddress(){const address=document.getElementById("address").value;const res=await fetch(`${API_BASE}/events/geocode?address=${encodeURIComponent(address)}`);if(res.ok){const {lat,lng}=await res.json();document.getElementById("lat").value=lat;document.getElementById("lng").value=lng;map.setView([lat,lng],14);}else{alert("כתובת לא נמצאה");}}
async function register(){const payload={username:document.getElementById("reg-username").value,email:document.getElementById("reg-email").value,password:document.getElementById("reg-password").value};const res=await fetch(`${API_BASE}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});alert(res.ok?"נרשמת בהצלחה":"שגיאה בהרשמה");}
async function login(){const form=new URLSearchParams();form.append("username",document.getElementById("login-username").value);form.append("password",document.getElementById("login-password").value);const res=await fetch(`${API_BASE}/auth/login`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:form});if(res.ok){const data=await res.json();token=data.access_token;alert("התחברת");}else{alert("שגיאת התחברות");}}
function enableNotifications(){if(Notification.permission==="granted"){alert("התראות כבר מופעלות");}else{Notification.requestPermission().then(p=>{if(p==="granted") alert("התראות הופעלו");});}}
function connectWS(){const proto=location.protocol==="https:"?"wss":"ws";const ws=new WebSocket(`${proto}://${window.location.host}/ws/events`);ws.onmessage=ev=>{const msg=JSON.parse(ev.data);if(msg.type==="new_event"){fetchEvents();if(Notification.permission==="granted"){new Notification("אירוע חדש",{body:msg.data.title});}}if(msg.type==="arrival"){if(Notification.permission==="granted"){new Notification("משתמש הצטרף",{body:msg.data.username});}}};}
initMap();fetchEvents();fetchHistory();connectWS();
</script>
</body></html>
