<script>
  // --- hardcoded cloud endpoints (Render) ---
  const API_BASE = "https://zufar.onrender.com";
  const WS_URL   = "wss://zufar.onrender.com/ws/events";

  // helper stays the same
  function fmt(dtStr) {
    try { return new Date(dtStr).toLocaleString(); } catch { return dtStr; }
  }

  async function loadEvents() {
    const res = await fetch(API_BASE + "/events");
    const data = await res.json();
    const list = document.getElementById("eventsList");
    list.innerHTML = "";
    data.sort((a,b) => new Date(b.event_time) - new Date(a.event_time));
    data.forEach(e => {
      const item = document.createElement("div");
      item.className = "list-group-item";
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${e.title} <span class="badge text-bg-${e.status==='closed'?'secondary':'success'}">${e.status}</span></h6>
          <small>${fmt(e.event_time)}</small>
        </div>
        <p class="mb-1">Severity: <strong>${e.severity}</strong> | Responders: ${e.people_count}/${e.people_required} | Casualties: ${e.casualties_count}</p>
        <button class="btn btn-sm btn-outline-primary" onclick="joinEvent(${e.id})">Join</button>
      `;
      list.appendChild(item);
    });
  }

  async function joinEvent(eventId) {
    const username = prompt("Enter your name to join:");
    if (!username) return;
    const res = await fetch(API_BASE + "/events/join", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ event_id: eventId, username })
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:"error"}));
      alert("Join failed: " + (err.detail || res.statusText));
    } else {
      await loadEvents();
    }
  }

  document.getElementById("createForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      title: form.title.value,
      description: form.description.value,
      reporter: form.reporter.value,
      severity: form.severity.value,
      lat: parseFloat(form.lat.value),
      lng: parseFloat(form.lng.value),
      people_required: parseInt(form.people_required.value, 10),
      casualties_count: parseInt(form.casualties_count.value, 10),
      event_time: new Date(form.event_time.value).toISOString()
    };
    const res = await fetch(API_BASE + "/events", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:"error"}));
      alert("Create failed: " + (err.detail || res.statusText));
    } else {
      form.reset();
      await loadEvents();
    }
  });

  document.getElementById("refreshBtn").addEventListener("click", loadEvents);

  // --- WebSocket with keepalive, hardcoded to Render ---
  (function initWS() {
    const ws = new WebSocket(WS_URL);
    ws.onopen = () => {
      console.log("WS connected:", WS_URL);
      setInterval(() => { try { ws.send("ping"); } catch(e) {} }, 25000);
    };
    ws.onmessage = (event) => {
      console.log("WS message:", event.data);
      loadEvents();
    };
    ws.onerror = (e) => console.error("WS error:", e);
    ws.onclose = () => {
      console.warn("WS closed. Reconnecting in 2s");
      setTimeout(initWS, 2000);
    };
  })();

  loadEvents();
</script>
