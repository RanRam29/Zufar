<!doctype html>
<html lang="he"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zufar â€“ × ×™×”×•×œ ××™×¨×•×¢×™×</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
header { background:#0b3d91;color:#fff;padding:10px;text-align:center; }
nav button { margin:5px; padding:5px 10px; }
#map{ height: 400px; } .hidden{display:none;}
.event-card{border:1px solid #ccc;padding:8px;margin:5px;border-radius:4px;}
.form-group{margin-bottom:10px;} label{display:block;margin-bottom:4px;} input,textarea,select{width:100%;padding:6px;}
</style></head>
<body>
<header><h1>ğŸ“ Zufar â€“ × ×™×”×•×œ ××™×¨×•×¢×™×</h1></header>
<nav>
  <button onclick="showTab('map-tab')">××¤×”</button>
  <button onclick="showTab('auth-tab')">×”×ª×—×‘×¨×•×ª / ×”×¨×©××”</button>
  <button onclick="showTab('history-tab')">××™×¨×•×¢×™× ×”×™×¡×˜×•×¨×™×™×</button>
</nav>
<section id="map-tab">
  <div id="map"></div>
  <h2>××™×¨×•×¢×™× ×¤×¢×™×œ×™×</h2>
  <div id="events-list"></div>
  <h3>×¦×•×¨ ××™×¨×•×¢ ×—×“×©</h3>
  <div id="create-event-form">
    <div class="form-group"><label>×›×•×ª×¨×ª</label><input id="title" type="text"/></div>
    <div class="form-group"><label>×—×•××¨×”</label>
      <select id="severity"><option value="low">× ××•×›×”</option><option value="medium">×‘×™× ×•× ×™×ª</option><option value="high">×’×‘×•×”×”</option></select>
    </div>
    <div class="form-group"><label>×ª×™××•×¨</label><textarea id="description"></textarea></div>
    <div class="form-group"><label>×›×ª×•×‘×ª (×‘×™×©×¨××œ)</label><input id="address" type="text"/> <button onclick="geocodeAddress()">ğŸ” ××¦× × ×§×•×“×ª ×¦×™×•×Ÿ</button></div>
    <div class="form-group"><label>Lat</label><input id="lat" type="number" step="any"/><label>Lng</label><input id="lng" type="number" step="any"/></div>
    <div class="form-group"><label>××¡×¤×¨ ×× ×©×™× × ×“×¨×©</label><input id="people_required" type="number" value="5"/></div>
    <button onclick="createEvent()">×¦×•×¨ ××™×¨×•×¢</button>
  </div>
</section>
<section id="auth-tab" class="hidden">
  <h2>×”×¨×©××”</h2>
  <div class="form-group"><label>×©× ××©×ª××©</label><input id="reg-username" type="text"/></div>
  <div class="form-group"><label>××™××™×™×œ</label><input id="reg-email" type="email"/></div>
  <div class="form-group"><label>×¡×™×¡××”</label><input id="reg-password" type="password"/></div>
  <button onclick="register()">×”×™×¨×©×</button>
  <h2>×”×ª×—×‘×¨×•×ª</h2>
  <div class="form-group"><label>×©× ××©×ª××©</label><input id="login-username" type="text"/></div>
  <div class="form-group"><label>×¡×™×¡××”</label><input id="login-password" type="password"/></div>
  <button onclick="login()">×”×ª×—×‘×¨</button>
  <div><button onclick="enableNotifications()">×”×¤×¢×œ ×”×ª×¨××•×ª</button></div>
</section>
<section id="history-tab" class="hidden">
  <h2>××™×¨×•×¢×™× ×”×™×¡×˜×•×¨×™×™×</h2><div id="history-list"></div>
</section>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_BASE = window.location.origin; let map, markers={}, token=null;
function showTab(id){document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden");}
function initMap(){map=L.map('map').setView([31.0461,34.8516],8);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Map data Â© OpenStreetMap'}).addTo(map);}
async function fetchEvents(){const res=await fetch(`${API_BASE}/events`);const data=await res.json();document.getElementById("events-list").innerHTML="";data.forEach(ev=>{const card=document.createElement("div");card.className="event-card";card.innerHTML=`<b>${ev.title}</b> (${ev.severity}) â€“ ${ev.people_count}/${ev.people_required} ××©×ª×ª×¤×™×<br><button onclick="joinEvent(${ev.id})">×”×¦×˜×¨×£</button> <button onclick="editEventPrompt(${ev.id})">×¢×¨×•×š</button>`;document.getElementById("events-list").appendChild(card);if(!markers[ev.id]){markers[ev.id]=L.marker([ev.lat,ev.lng]).addTo(map).bindPopup(ev.title);}else{markers[ev.id].setLatLng([ev.lat,ev.lng]).setPopupContent(ev.title);}})}
async function fetchHistory(){const r=await fetch(`${API_BASE}/events/history`);const data=await r.json();const c=document.getElementById("history-list");c.innerHTML="";data.forEach(ev=>{const card=document.createElement("div");card.className="event-card";card.innerHTML=`<b>${ev.title}</b> (${ev.severity}) â€“ × ×¡×’×¨`;c.appendChild(card);});}
async function createEvent(){const payload={title:document.getElementById("title").value,severity:document.getElementById("severity").value,description:document.getElementById("description").value,address:document.getElementById("address").value,lat:parseFloat(document.getElementById("lat").value),lng:parseFloat(document.getElementById("lng").value),people_required:parseInt(document.getElementById("people_required").value)};const res=await fetch(`${API_BASE}/events`,{method:"POST",headers:{"Content-Type":"application/json",...(token?{Authorization:`Bearer ${token}`}:{})},body:JSON.stringify(payload)});if(res.ok){alert("××™×¨×•×¢ × ×•×¦×¨");fetchEvents();}else{alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”××™×¨×•×¢");}}
async function editEventPrompt(id){const newRequired=prompt("××¡×¤×¨ ××©×ª×ª×¤×™× × ×“×¨×© ×—×“×© (××• ×”×©××¨ ×¨×™×§):");const newTitle=prompt("×›×•×ª×¨×ª ×—×“×©×” (××• ×¨×™×§):");const body={};if(newRequired) body.people_required=parseInt(newRequired);if(newTitle) body.title=newTitle;if(!Object.keys(body).length) return;const res=await fetch(`${API_BASE}/events/${id}/edit`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(res.ok){fetchEvents();}else{alert("×¢×¨×™×›×” × ×›×©×œ×”");}}
async function joinEvent(id){const username=prompt("×”×›× ×¡ ×©× ×œ×”×¦×˜×¨×¤×•×ª:");if(!username) return;const res=await fetch(`${API_BASE}/events/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event_id:id,username})});if(res.ok){alert("×”×¦×˜×¨×¤×ª ×œ××™×¨×•×¢");fetchEvents();}}
async function geocodeAddress(){const address=document.getElementById("address").value;const res=await fetch(`${API_BASE}/events/geocode?address=${encodeURIComponent(address)}`);if(res.ok){const {lat,lng}=await res.json();document.getElementById("lat").value=lat;document.getElementById("lng").value=lng;map.setView([lat,lng],14);}else{alert("×›×ª×•×‘×ª ×œ× × ××¦××”");}}
async function register(){const payload={username:document.getElementById("reg-username").value,email:document.getElementById("reg-email").value,password:document.getElementById("reg-password").value};const res=await fetch(`${API_BASE}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});alert(res.ok?"× ×¨×©××ª ×‘×”×¦×œ×—×”":"×©×’×™××” ×‘×”×¨×©××”");}
async function login(){const form=new URLSearchParams();form.append("username",document.getElementById("login-username").value);form.append("password",document.getElementById("login-password").value);const res=await fetch(`${API_BASE}/auth/login`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:form});if(res.ok){const data=await res.json();token=data.access_token;alert("×”×ª×—×‘×¨×ª");}else{alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª");}}
function enableNotifications(){if(Notification.permission==="granted"){alert("×”×ª×¨××•×ª ×›×‘×¨ ××•×¤×¢×œ×•×ª");}else{Notification.requestPermission().then(p=>{if(p==="granted") alert("×”×ª×¨××•×ª ×”×•×¤×¢×œ×•");});}}
function connectWS(){const proto=location.protocol==="https:"?"wss":"ws";const ws=new WebSocket(`${proto}://${window.location.host}/ws/events`);ws.onmessage=ev=>{const msg=JSON.parse(ev.data);if(msg.type==="new_event"){fetchEvents();if(Notification.permission==="granted"){new Notification("××™×¨×•×¢ ×—×“×©",{body:msg.data.title});}}if(msg.type==="arrival"){if(Notification.permission==="granted"){new Notification("××©×ª××© ×”×¦×˜×¨×£",{body:msg.data.username});}}};}
initMap();fetchEvents();fetchHistory();connectWS();
</script>
</body></html>
